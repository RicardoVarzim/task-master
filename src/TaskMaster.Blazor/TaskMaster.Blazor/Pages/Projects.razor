@page "/projects"
@using TaskMaster.Core.Models
@using TaskMaster.Blazor.Services
@using System.Net.Http.Json
@using TaskModel = TaskMaster.Core.Models.Task
@using TaskStatusModel = TaskMaster.Core.Models.TaskStatus
@inject HttpClient HttpClient
@inject TaskService TaskService
@inject SyncService SyncService
@inject NavigationManager Navigation

<PageTitle>Task Master - Projects</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Projects</h1>
            @if (ProjectList.Any())
            {
                <p class="text-muted">
                    @ProjectList.Count project(s) • @totalTasks total tasks • @completedTasks completed
                </p>
            }
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-primary me-2" @onclick="SyncAllProjects" disabled="@isSyncing">
                @if (isSyncing)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                else
                {
                    <span class="oi oi-reload me-1"></span>
                }
                Sync All
            </button>
            <button class="btn btn-primary" @onclick="ShowAddDialog">Add Project</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (ProjectList.Any())
    {
        <div class="row">
            @foreach (var project in ProjectList)
            {
                var projectStats = GetProjectStats(project.Id);
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">@project.Name</h5>
                                @if (!string.IsNullOrEmpty(project.GitRepositoryPath))
                                {
                                    <span class="badge bg-success">Git</span>
                                }
                            </div>
                            <p class="card-text">
                                <small class="text-muted">@project.FullPath</small>
                            </p>
                            
                            @if (projectStats.TotalTasks > 0)
                            {
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Tasks</small>
                                        <small class="text-muted">@projectStats.CompletedTasks / @projectStats.TotalTasks</small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" 
                                             role="progressbar" 
                                             style="width: @(projectStats.CompletionPercentage)%"
                                             aria-valuenow="@projectStats.CompletionPercentage" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex gap-2">
                                        <span class="badge bg-primary">@projectStats.PendingTasks Pending</span>
                                        <span class="badge bg-info">@projectStats.InProgressTasks In Progress</span>
                                        @if (projectStats.BlockedTasks > 0)
                                        {
                                            <span class="badge bg-danger">@projectStats.BlockedTasks Blocked</span>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning mt-3 mb-0 py-2">
                                    <small>No tasks found. Add tasks in the <code>.tasks</code> folder.</small>
                                </div>
                            }

                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" 
                                        @onclick="() => SyncProject(project.Id)"
                                        disabled="@(isSyncingProject == project.Id)">
                                    @if (isSyncingProject == project.Id)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    Sync
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        @onclick="() => ShowSyncHistory(project.Id)">
                                    <span class="oi oi-clock me-1"></span>History
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        @onclick="() => ViewTasks(project.Id)">
                                    View Tasks
                                </button>
                                <button class="btn btn-sm btn-danger ms-auto" 
                                        @onclick="() => DeleteProject(project.Id)">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No projects found. Click "Add Project" to add your first project.
        </div>
    }
</div>

@if (showAddDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Project</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="projectPath" class="form-label">Project Path</label>
                        <input type="text" class="form-control" id="projectPath" @bind="newProjectPath" placeholder="C:\path\to\project" />
                        <small class="form-text text-muted">Enter the full path to your project folder</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="AddProject">Add</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@if (showSyncHistory && selectedProjectId.HasValue)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sync History</h5>
                    <button type="button" class="btn-close" @onclick="CloseSyncHistory"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingHistory)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (syncHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Files</th>
                                        <th>Tasks</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var history in syncHistory)
                                    {
                                        <tr>
                                            <td>@history.StartedAt.ToString("g")</td>
                                            <td>
                                                <span class="badge bg-secondary">@history.SyncType</span>
                                            </td>
                                            <td>
                                                @if (history.Status == SyncStatus.Success)
                                                {
                                                    <span class="badge bg-success">Success</span>
                                                }
                                                else if (history.Status == SyncStatus.Failed)
                                                {
                                                    <span class="badge bg-danger">Failed</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">Partial</span>
                                                }
                                            </td>
                                            <td>@history.FilesProcessed</td>
                                            <td>
                                                <small>
                                                    Found: @history.TasksFound<br/>
                                                    Added: @history.TasksAdded<br/>
                                                    Removed: @history.TasksRemoved
                                                </small>
                                            </td>
                                            <td>
                                                @if (history.DurationMs.HasValue)
                                                {
                                                    <span>@(history.DurationMs.Value)ms</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                        @if (!string.IsNullOrEmpty(history.ErrorMessage))
                                        {
                                            <tr>
                                                <td colspan="6" class="text-danger small">
                                                    <strong>Error:</strong> @history.ErrorMessage
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            No sync history found for this project.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSyncHistory">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<Project> ProjectList = new();
    private List<TaskModel> allTasks = new();
    private bool isLoading = true;
    private bool showAddDialog = false;
    private bool isSyncing = false;
    private int? isSyncingProject = null;
    private string newProjectPath = "";
    private int totalTasks = 0;
    private int completedTasks = 0;
    private bool showSyncHistory = false;
    private int? selectedProjectId = null;
    private List<SyncHistory> syncHistory = new();
    private bool isLoadingHistory = false;

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        HttpClient.BaseAddress = new Uri("http://localhost:5000");
        await LoadData();
    }

    private async System.Threading.Tasks.Task LoadData()
    {
        isLoading = true;
        try
        {
            await LoadProjects();
            await LoadTasks();
            CalculateStats();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task LoadProjects()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<List<Project>>("/api/projects");
            ProjectList = response ?? new List<Project>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading projects: {ex.Message}");
        }
    }

    private async System.Threading.Tasks.Task LoadTasks()
    {
        try
        {
            allTasks = await TaskService.GetTasksAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
        }
    }

    private void CalculateStats()
    {
        totalTasks = allTasks.Count;
        completedTasks = allTasks.Count(t => t.IsCompleted);
    }

    private ProjectStats GetProjectStats(int projectId)
    {
        var projectTasks = allTasks.Where(t => t.ProjectId == projectId).ToList();
        return new ProjectStats
        {
            TotalTasks = projectTasks.Count,
            CompletedTasks = projectTasks.Count(t => t.IsCompleted),
            PendingTasks = projectTasks.Count(t => t.Status == TaskStatusModel.Pending),
            InProgressTasks = projectTasks.Count(t => t.Status == TaskStatusModel.InProgress),
            BlockedTasks = projectTasks.Count(t => t.Status == TaskStatusModel.Blocked),
            CompletionPercentage = projectTasks.Count > 0 
                ? (int)((double)projectTasks.Count(t => t.IsCompleted) / projectTasks.Count * 100)
                : 0
        };
    }

    private void ShowAddDialog()
    {
        showAddDialog = true;
        newProjectPath = "";
    }

    private void CloseAddDialog()
    {
        showAddDialog = false;
    }

    private async System.Threading.Tasks.Task AddProject()
    {
        if (string.IsNullOrWhiteSpace(newProjectPath))
        {
            return;
        }

        try
        {
            var response = await HttpClient.PostAsJsonAsync("/api/projects", new { Path = newProjectPath });
            if (response.IsSuccessStatusCode)
            {
                showAddDialog = false;
                await LoadProjects();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error adding project: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding project: {ex.Message}");
        }
    }

    private async System.Threading.Tasks.Task DeleteProject(int projectId)
    {
        // Note: In a real implementation, you'd use a JavaScript interop for confirm dialog
        try
        {
            var response = await HttpClient.DeleteAsync($"/api/projects/{projectId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting project: {ex.Message}");
        }
    }

    private async System.Threading.Tasks.Task SyncProject(int projectId)
    {
        isSyncingProject = projectId;
        try
        {
            var response = await HttpClient.PostAsync($"/api/sync/project/{projectId}", null);
            if (response.IsSuccessStatusCode)
            {
                await System.Threading.Tasks.Task.Delay(1000); // Wait for sync to complete
                await LoadTasks();
                CalculateStats();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error syncing project: {ex.Message}");
        }
        finally
        {
            isSyncingProject = null;
        }
    }

    private async System.Threading.Tasks.Task SyncAllProjects()
    {
        isSyncing = true;
        try
        {
            await TaskService.SyncAllProjectsAsync();
            await System.Threading.Tasks.Task.Delay(2000); // Wait for sync to complete
            await LoadTasks();
            CalculateStats();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error syncing all projects: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private void ViewTasks(int projectId)
    {
        Navigation.NavigateTo($"/tasks?projectId={projectId}");
    }

    private async System.Threading.Tasks.Task ShowSyncHistory(int projectId)
    {
        selectedProjectId = projectId;
        showSyncHistory = true;
        isLoadingHistory = true;
        try
        {
            syncHistory = await SyncService.GetSyncHistoryAsync(projectId, 50);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sync history: {ex.Message}");
            syncHistory = new List<SyncHistory>();
        }
        finally
        {
            isLoadingHistory = false;
        }
    }

    private void CloseSyncHistory()
    {
        showSyncHistory = false;
        selectedProjectId = null;
        syncHistory = new List<SyncHistory>();
    }

    private class ProjectStats
    {
        public int TotalTasks { get; set; }
        public int CompletedTasks { get; set; }
        public int PendingTasks { get; set; }
        public int InProgressTasks { get; set; }
        public int BlockedTasks { get; set; }
        public int CompletionPercentage { get; set; }
    }
}

